<div class="charts-container">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Dashboard de Stock</h2>
    <div class="btn-group">
      <button class="btn btn-sm btn-outline-primary" (click)="exportChartsToPdf()">
        <i class="fas fa-file-pdf me-1"></i> Imprimir / PDF
      </button>
    </div>
  </div>

  <!-- Warning for admin if centers failed to load -->
  <div *ngIf="isAdmin && centers.length === 0" class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Advertencia:</strong> No se pudieron cargar los centros. Los datos mostrados corresponden a su centro
    asignado.
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="row">
      <div class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Tipo</mat-label>
          <mat-select [(ngModel)]="viewType" (selectionChange)="onViewTypeChange()" panelClass="custom-panel">
            <mat-option value="stock">Stock</mat-option>
            <mat-option value="movimientos">Compras y Distribuciones</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div *ngIf="isAdmin" class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Centro</mat-label>
          <mat-select [(ngModel)]="centerId" (selectionChange)="onCenterChange()" [disabled]="centers.length === 0"
            panelClass="custom-panel">
            <mat-option [value]="undefined">{{centers.length === 0 ? 'Centros no disponibles' : 'Todos los
              centros'}}</mat-option>
            <mat-option *ngFor="let center of centers" [value]="center.id">{{center.name}}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Categoría</mat-label>
          <mat-select [(ngModel)]="categoryId" (selectionChange)="onCategoryChange()" panelClass="custom-panel">
            <mat-option [value]="undefined">Todas las categorías</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category.id">{{category.name}}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Producto</mat-label>
          <mat-select [(ngModel)]="productId" (selectionChange)="onProductChange()" panelClass="custom-panel">
            <mat-option [value]="undefined">Todos los productos</mat-option>
            <mat-option *ngFor="let product of products" [value]="product.id">{{product.name}}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Desde</mat-label>
          <input matInput [matDatepicker]="pickerFrom" [(ngModel)]="fromDate" (dateChange)="onDateChange()"
            [max]="today">
          <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
          <mat-datepicker #pickerFrom></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="col-md-3 col-6 mb-3">
        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
          <mat-label>Hasta</mat-label>
          <input matInput [matDatepicker]="pickerTo" [(ngModel)]="toDate" (dateChange)="onDateChange()" [max]="today">
          <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
          <mat-datepicker #pickerTo></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <!-- Clear Filters Button -->
    <div class="row mt-2">
      <div class="col-12 text-end">
        <button class="btn btn-outline-secondary btn-sm" (click)="clearAllFilters()">
          <i class="fas fa-times"></i> Limpiar filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="ms-3">Cargando datos...</p>
  </div>

  <!-- No Data Message -->
  <div *ngIf="!isLoading && stockData.length === 0" class="no-data-container">
    <div class="no-data-content">
      <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">No hay datos disponibles</h4>
      <p class="text-muted">No se encontraron registros para los filtros aplicados.</p>
      <button class="btn btn-primary mt-2" (click)="clearAllFilters()">
        <i class="fas fa-refresh"></i> Limpiar filtros
      </button>
    </div>
  </div>

  <!-- Charts Grid -->
  <div *ngIf="!isLoading && stockData.length > 0" class="charts-grid">
    <!-- Stock por Categoría (Pie Chart) -->
    <div class="chart-container">
      <h3>Stock por Categoría</h3>
      <div class="chart-wrapper">
        <canvas baseChart [data]="pieChartData" [type]="'pie'" [options]="pieChartOptions">
        </canvas>
      </div>
    </div>

    <!-- Top 10 Productos (Bar Chart) -->
    <div class="chart-container">
      <h3>Top 10 Productos con Mayor Stock</h3>
      <div class="chart-wrapper">
        <canvas baseChart [data]="barChartData" [type]="'bar'" [options]="barChartOptions">
        </canvas>
      </div>
    </div>

    <!-- Evolución en el Tiempo (Line Chart) -->
    <div class="chart-container">
      <h3>Evolución en el Tiempo</h3>
      <div *ngIf="shouldShowTimeChart(); else timeChartMessage" class="chart-wrapper">
        <canvas baseChart [data]="lineChartData" [type]="'line'" [options]="lineChartOptions">
        </canvas>
      </div>
      <ng-template #timeChartMessage>
        <div *ngIf="isAdmin" class="d-flex flex-column align-items-center justify-content-center text-muted p-4"
          style="height:100%;min-height:220px;">
          <i class="fas fa-filter fa-2x mb-2"></i>
          <p class="mb-0 text-center" style="font-size: 0.9rem;">
            Para mostrar el grafico de linea de tiempo, filtra por producto, centro y tipo.
          </p>
        </div>
        <div *ngIf="!isAdmin" class="d-flex flex-column align-items-center justify-content-center text-muted p-4"
          style="height:100%;min-height:220px;">
          <i class="fas fa-filter fa-2x mb-2"></i>
          <p class="mb-0 text-center" style="font-size: 0.9rem;">
            Para mostrar el grafico de linea de tiempo, filtra por producto y tipo.
          </p>
        </div>
      </ng-template>
    </div>

    <!-- Ingresos vs Egresos (Doughnut Chart) -->
    <div class="chart-container">
      <h3>Ingresos vs Egresos</h3>
      <div class="chart-wrapper">
        <canvas baseChart [data]="doughnutChartData" [type]="'doughnut'" [options]="doughnutChartOptions">
        </canvas>
      </div>
    </div>
  </div>
</div>